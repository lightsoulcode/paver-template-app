from flask import Flask, request, render_template, send_file, redirect, flash
import pandas as pd
from datetime import datetime
from io import BytesIO
import os

app = Flask(__name__)
app.secret_key = 'secret123'

def clean_df(df):
    df.columns = df.columns.str.strip()
    df = df.applymap(lambda x: str(x).strip().replace('\n', ' ').replace('\r', '') if pd.notnull(x) else '')
    return df

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/process', methods=['POST'])
def process():
    file = request.files.get('excel_file')
    action = request.form.get('action')

    if not file or not action:
        flash("Please select both a file and a template type.")
        return redirect('/')

    df = pd.read_excel(file, dtype=str)
    df = clean_df(df)
    timestamp = datetime.now().strftime('%Y-%m-%d_%H%M')

    if action == 'Name':
        df = df[df["Action"].str.title() == "Modify"]
        df = df[df["New Name"].str.strip() != ""]
        result = pd.DataFrame({
            "PLACEID": df["PlaceID"],
            "CHANGETYPE": "UPDATE",
            "ATTRIBUTENAME": "NAME",
            "PRIMARY": "TRUE",
            "LANGUAGECODE": "",
            "NAMETYPE": "OFFICIAL",
            "BASETEXT": df["New Name"],
            "PREVIOUS_NAMETYPE": "OFFICIAL",
            "PREVIOUS_LANGUAGECODE": "",
            "PREVIOUS_BASETEXT": df["Previous Name"]
        })
        filename = f"Name_TEMPLATE_{timestamp}.csv"

    elif action == 'Status':
        df = df[df["Action"].str.upper() == "TBC-DELETE"]
        result = pd.DataFrame({
            "PLACEID": df["PlaceID"],
            "CHANGETYPE": "UPDATE",
            "ATTRIBUTENAME": "STATUS",
            "PLACESTATUS": "INACTIVE"
        })
        filename = f"Status_TEMPLATE_{timestamp}.csv"

    elif action == 'Location':
        df = df[df["Action"].str.upper() == "MODIFY"]
        def split_lat_lon(val): return (val.split(',')[0].strip(), val.split(',')[1].strip()) if pd.notna(val) and ',' in val else ('', '')
        df[['DISPLAY_LAT', 'DISPLAY_LON']] = df['New Display Point'].apply(lambda x: pd.Series(split_lat_lon(x)))
        df[['ROUTING_LAT', 'ROUTING_LON']] = df['New Routing Point'].apply(lambda x: pd.Series(split_lat_lon(x)))
        fields = ['New House number', 'New Street Name', 'New Postal Code', 'DISPLAY_LAT', 'DISPLAY_LON', 'ROUTING_LAT', 'ROUTING_LON']
        df = df[df[fields].apply(lambda row: any(cell.strip() for cell in row), axis=1)]
        result = pd.DataFrame({
            'PLACEID': df['PlaceID'],
            'CHANGETYPE': 'UPDATE',
            'ATTRIBUTENAME': 'LOCATION',
            'FULLROADNAME': df['New Street Name'],
            'HOUSENUMBER': df['New House number'],
            'POSTALCODE': df['New Postal Code'],
            'DISPLAY_GEO_POSITION_LATITUDE': df['DISPLAY_LAT'],
            'DISPLAY_GEO_POSITION_LONGITUDE': df['DISPLAY_LON'],
            'ROUTING_GEO_POSITION_LATITUDE': df['ROUTING_LAT'],
            'ROUTING_GEO_POSITION_LONGITUDE': df['ROUTING_LON']
        })
        filename = f"Location_TEMPLATE_{timestamp}.csv"

    elif action == 'Category':
        category_map = {  # You can externalize this for manageability
            "Restaurant": "100-1000-0000",
            "Casual Dining":"100-1000-0001",
            "Fine Dining":"100-1000-0002",
            "Take Out and Delivery Only":"100-1000-0003",
            "Food Market-Stall":"100-1000-0004",
            "Taqueria":"100-1000-0005",
            "Deli":"100-1000-0006",
            "Cafeteria":"100-1000-0007",
            "Bistro":"100-1000-0008",
            "Fast Food":"100-1000-0009",
            "Family Restaurant":"100-1000-0050",
            "Coffee-Tea":"100-1100-0000",
            "Coffee Shop":"100-1100-0010",
            "Tea House":"100-1100-0331",
            "Nightlife-Entertainment":"200-2000-0000",
            "Bar or Pub":"200-2000-0011",
            "Night Club":"200-2000-0012",
            "Dancing":"200-2000-0013",
            "Karaoke":"200-2000-0014",
            "Live Entertainment-Music":"200-2000-0015",
            "Billiards-Pool Hall":"200-2000-0016",
            "Video Arcade-Game Room":"200-2000-0017",
            "Jazz Club":"200-2000-0018",
            "Beer Garden":"200-2000-0019",
            "Adult Entertainment":"200-2000-0306",
            "Cocktail Lounge":"200-2000-0368",
            "Cinema":"200-2100-0019",
            "Theatre, Music and Culture":"200-2200-0000",
            "Performing Arts":"200-2200-0020",
            "Gambling-Lottery-Betting":"200-2300-0000",
            "Casino":"200-2300-0021",
            "Lottery Booth":"200-2300-0022",
            "Landmark-Attraction":"300-3000-0000",
            "Tourist Attraction":"300-3000-0023",
            "Gallery":"300-3000-0024",
            "Historical Monument":"300-3000-0025",
            "Castle":"300-3000-0030",
            "Winery":"300-3000-0065",
            "Named Intersection-Chowk":"300-3000-0232",
            "Brewery":"300-3000-0350",
            "Distillery":"300-3000-0351",
            "Hot Spring":"300-3000-0450",
            "Museum":"300-3100-0000",
            "Science Museum":"300-3100-0026",
            "Children's Museum":"300-3100-0027",
            "History Museum":"300-3100-0028",
            "Art Museum":"300-3100-0029",
            "Religious Place":"300-3200-0000",
            "Church":"300-3200-0030",
            "Temple":"300-3200-0031",
            "Synagogue":"300-3200-0032",
            "Ashram":"300-3200-0033",
            "Mosque":"300-3200-0034",
            "Shrine":"300-3200-0035",
            "Other Place of Worship":"300-3200-0309",
            "Gurdwara":"300-3200-0375",
            "Pagoda":"300-3200-0376",
            "Body of water":"350-3500-0233",
            "Reservoir":"350-3500-0234",
            "Waterfall":"350-3500-0235",
            "Bay-Harbor":"350-3500-0300",
            "River":"350-3500-0302",
            "Canal":"350-3500-0303",
            "Lake":"350-3500-0304",
            "Mountain or Hill":"350-3510-0236",
            "Mountain Passes":"350-3510-0237",
            "Mountain Peaks":"350-3510-0238",
            "Undersea Feature":"350-3520-0224",
            "Forest, Heath or Other Vegetation":"350-3522-0239",
            "Natural and Geographical":"350-3550-0336",
            "Public Sports Airport":"400-4000-4580",
            "Airport":"400-4000-4581",
            "Airport Terminal":"400-4000-4582",
            "Train Station":"400-4100-0035",
            "Bus Station":"400-4100-0036",
            "Underground Train-Subway":"400-4100-0037",
            "Commuter Rail Station":"400-4100-0038",
            "Commuter Train":"400-4100-0039",
            "Public Transit Access":"400-4100-0040",
            "Transportation Service":"400-4100-0041",
            "Bus Stop":"400-4100-0042",
            "Local Transit":"400-4100-0043",
            "Ferry Terminal":"400-4100-0044",
            "Boat Ferry":"400-4100-0045",
            "Rail Ferry":"400-4100-0046",
            "Taxi Stand":"400-4100-0047",
            "Rideshare Pickup":"400-4100-0051",
            "Highway Entrance":"400-4100-0225",
            "Highway Exit":"400-4100-0226",
            "Tollbooth":"400-4100-0326",
            "Lightrail":"400-4100-0337",
            "Water Transit":"400-4100-0338",
            "Monorail":"400-4100-0339",
            "Aerial Tramway":"400-4100-0340",
            "Bus Rapid Transit":"400-4100-0341",
            "Inclined Rail":"400-4100-0342",
            "Bicycle Sharing Location":"400-4100-0347",
            "Bicycle Parking":"400-4100-0348",
            "Weigh Station":"400-4200-0048",
            "Cargo Center":"400-4200-0049",
            "Rail Yard":"400-4200-0050",
            "Seaport-Harbour":"400-4200-0051",
            "Airport Cargo":"400-4200-0052",
            "Couriers":"400-4200-0240",
            "Cargo Transportation":"400-4200-0241",
            "Delivery Entrance":"400-4200-0311",
            "Loading Dock":"400-4200-0312",
            "Loading Zone":"400-4200-0313",
            "Rest Area":"400-4300-0000",
            "Complete Rest Area":"400-4300-0199",
            "Parking and Restroom Only Rest Area":"400-4300-0200",
            "Parking Only Rest Area":"400-4300-0201",
            "Motorway Service Rest Area":"400-4300-0202",
            "Roadside Station":"400-4300-0251",
            "Scenic Overlook Rest Area":"400-4300-0308",
            "Hotel or Motel":"500-5000-0000",
            "Hotel":"500-5000-0053",
            "Motel":"500-5000-0054",
            "Lodging":"500-5100-0000",
            "Hostel":"500-5100-0055",
            "Campground":"500-5100-0056",
            "Guest House":"500-5100-0057",
            "Bed and Breakfast":"500-5100-0058",
            "Holiday Park":"500-5100-0059",
            "Short-Time Motel":"500-5100-0060",
            "Ryokan":"500-5100-0061",
            "Outdoor-Recreation":"550-5510-0000",
            "Park-Recreation Area":"550-5510-0202",
            "Sports Field":"550-5510-0203",
            "Garden":"550-5510-0204",
            "Beach":"550-5510-0205",
            "Recreation Center":"550-5510-0206",
            "Ski Lift":"550-5510-0227",
            "Scenic Point":"550-5510-0242",
            "Off Road Trailhead":"550-5510-0358","Trailhead":"550-5510-0359",
            "Off-Road Vehicle Area":"550-5510-0374",
            "Campsite":"550-5510-0378",
            "Outdoor Service":"550-5510-0379",
            "Ranger Station":"550-5510-0380",
            "Bicycle Service":"550-5510-0387",
            "Leisure":"550-5520-0000",
            "Amusement Park":"550-5520-0207",
            "Zoo":"550-5520-0208",
            "Wild Animal Park":"550-5520-0209",
            "Wildlife Refuge":"550-5520-0210",
            "Aquarium":"550-5520-0211",
            "Ski Resort":"550-5520-0212",
            "Animal Park":"550-5520-0228",
            "Water Park":"550-5520-0357",
            "Convenience Store":"600-6000-0061",
            "Shopping Mall":"600-6100-0062",
            "Department Store":"600-6200-0063",
            "Food-Beverage Specialty Store":"600-6300-0064",
            "Grocery":"600-6300-0066",
            "Specialty Food Store":"600-6300-0067",
            "Wine and Liquor":"600-6300-0068",
            "Bakery and Baked Goods Store":"600-6300-0244",
            "Sweet Shop":"600-6300-0245",
            "Doughnut Shop":"600-6300-0246",
            "Butcher":"600-6300-0363",
            "Dairy Goods":"600-6300-0364",
            "Drugstore or Pharmacy":"600-6400-0000",
            "Drugstore":"600-6400-0069",
            "Pharmacy":"600-6400-0070",
            "Consumer Electronics Store":"600-6500-0072",
            "Mobile Retailer":"600-6500-0073",
            "Mobile Service Center":"600-6500-0074",
            "Computer and Software":"600-6500-0075",
            "Entertainment Electronics":"600-6500-0076",
            "Hardware, House and Garden":"600-6600-0000",
            "Home Improvement-Hardware Store":"600-6600-0077",
            "Home Specialty Store":"600-6600-0078",
            "Floor and Carpet":"600-6600-0079",
            "Furniture Store":"600-6600-0080",
            "Garden Center":"600-6600-0082",
            "Glass and Window":"600-6600-0083",
            "Lumber":"600-6600-0084",
            "Major Appliance":"600-6600-0085",
            "Power Equipment Dealer":"600-6600-0310",
            "Paint Store":"600-6600-0319",
            "Other Bookshop":"600-6700-0000",
            "Bookstore":"600-6700-0087",
            "Clothing and Accessories":"600-6800-0000",
            "Men's Apparel":"600-6800-0089",
            "Women's Apparel":"600-6800-0090",
            "Children's Apparel":"600-6800-0091",
            "Shoes-Footwear":"600-6800-0092",
            "Specialty Clothing Store":"600-6800-0093",
            "Consumer Goods":"600-6900-0000",
            "Sporting Goods Store":"600-6900-0094",
            "Office Supply and Services Store":"600-6900-0095",
            "Specialty Store":"600-6900-0096",
            "Pet Supply":"600-6900-0097",
            "Wholesale Store":"600-6900-0098",
            "General Merchandise":"600-6900-0099",
            "Discount Store":"600-6900-0100",
            "Flowers and Jewelry":"600-6900-0101",
            "Variety Store":"600-6900-0102",
            "Gift, Antique and Art":"600-6900-0103",
            "Record, CD and Video":"600-6900-0105",
            "Video and Game Rental":"600-6900-0106",
            "Cigar and Tobacco Shop":"600-6900-0107",
            "Vaping Store":"600-6900-0108",
            "Bicycle and Bicycle Accessories Shop":"600-6900-0246",
            "Market":"600-6900-0247",
            "Motorcycle Accessories":"600-6900-0248",
            "Non-Store Retailers":"600-6900-0249",
            "Pawnshop":"600-6900-0250",
            "Used-Second Hand Merchandise Stores":"600-6900-0251",
            "Adult Shop":"600-6900-0305","Arts and Crafts Supplies":"600-6900-0307",
            "Florist":"600-6900-0355",
            "Jeweler":"600-6900-0356",
            "Toy Store":"600-6900-0358",
            "Hunting-Fishing Shop":"600-6900-0388",
            "Running-Walking Shop":"600-6900-0389",
            "Skate Shop":"600-6900-0390",
            "Ski Shop":"600-6900-0391",
            "Snowboard Shop":"600-6900-0392",
            "Surf Shop":"600-6900-0393",
            "BMX Shop":"600-6900-0394",
            "Camping-Hiking Shop":"600-6900-0395",
            "Canoe-Kayak Shop":"600-6900-0396",
            "Cross Country Ski Shop":"600-6900-0397",
            "Tack Shop":"600-6900-0398",
            "Hair and Beauty":"600-6950-0000",
            "Barber":"600-6950-0399",
            "Nail Salon":"600-6950-0400",
            "Hair Salon":"600-6950-0401",
            "Bank":"700-7000-0107",
            "ATM":"700-7010-0108",
            "Money Transferring Service":"700-7050-0109",
            "Check Cashing Service-Currency Exchange":"700-7050-0110",
            "Communication-Media":"700-7100-0000",
            "Telephone Service":"700-7100-0134",
            "Commercial Services":"700-7200-0000",
            "Advertising-Marketing, PR and Market Research":"700-7200-0252",
            "Catering and Other Food Services":"700-7200-0253",
            "Construction":"700-7200-0254",
            "Customer Care-Service Center":"700-7200-0255",
            "Engineering and Scientific Services":"700-7200-0256",
            "Farming":"700-7200-0257",
            "Food Production":"700-7200-0258",
            "Human Resources and Recruiting Services":"700-7200-0259",
            "Investigation Services":"700-7200-0260",
            "IT and Office Equipment Services":"700-7200-0261",
            "Landscaping Services":"700-7200-0262",
            "Locksmiths and Security Systems Services":"700-7200-0263",
            "Management and Consulting Services":"700-7200-0264",
            "Manufacturing":"700-7200-0265",
            "Mining, Quarrying and Other Extraction":"700-7200-0266",
            "Modeling Agencies":"700-7200-0267",
            "Motorcycle Service and Maintenance":"700-7200-0268",
            "Organizations and Societies":"700-7200-0269",
            "Entertainment and Recreation":"700-7200-0270",
            "Finance and Insurance":"700-7200-0271",
            "Healthcare and Healthcare Support Services":"700-7200-0272",
            "Rental and Leasing":"700-7200-0274",
            "Repair and Maintenance Services":"700-7200-0275",
            "Printing and Publishing":"700-7200-0276",
            "Specialty Trade Contractors":"700-7200-0277",
            "Towing Service":"700-7200-0278",
            "Translation and Interpretation Services":"700-7200-0279",
            "Apartment Rental-Flat Rental":"700-7200-0324",
            "B2B Sales and Services":"700-7200-0328",
            "B2B Restaurant Services":"700-7200-0329",
            "Aviation":"700-7200-0330",
            "Interior and Exterior Design":"700-7200-0342",
            "Property Management":"700-7200-0344",
            "Financial Investment Firm":"700-7200-0345",
            "Warehouse":"700-7200-0351",
            "Fulfillment and Distribution Center":"700-7200-0352",
            "Business Facility":"700-7250-0136",
            "Police Box":"700-7300-0110",
            "Police Station":"700-7300-0111",
            "Police Services-Security":"700-7300-0112",
            "Fire Department":"700-7300-0113",
            "Ambulance Services":"700-7300-0280",
            "Consumer Services":"700-7400-0000",
            "Travel Agent-Ticketing":"700-7400-0133",
            "Dry Cleaning and Laundry":"700-7400-0137",
            "Attorney":"700-7400-0138",
            "Boating":"700-7400-0140","Business Service":"700-7400-0141","Funeral Director":"700-7400-0142",
            "Mover":"700-7400-0143",
            "Photography":"700-7400-0144",
            "Real Estate Services":"700-7400-0145",
            "Repair Service":"700-7400-0146",
            "Social Service":"700-7400-0147",
            "Storage":"700-7400-0148",
            "Tailor and Alteration":"700-7400-0149",
            "Tax Service":"700-7400-0150",
            "Utilities":"700-7400-0151",
            "Waste and Sanitary":"700-7400-0152",
            "Bicycle Service and Maintenance":"700-7400-0281",
            "Bill Payment Service":"700-7400-0282",
            "Body Piercing and Tattoos":"700-7400-0283",
            "Wedding Services and Bridal Studio":"700-7400-0284",
            "Internet Cafe":"700-7400-0285",
            "Kindergarten and Childcare":"700-7400-0286",
            "Maid Services":"700-7400-0287",
            "Marriage and Match Making Services":"700-7400-0288",
            "Public Administration":"700-7400-0289",
            "Wellness Center and Services":"700-7400-0292",
            "Pet Care":"700-7400-0293",
            "Legal Services":"700-7400-0327",
            "Tanning Salon":"700-7400-0343",
            "Recycling Center":"700-7400-0352",
            "Electrical":"700-7400-0365",
            "Plumbing":"700-7400-0366",
            "Post Office":"700-7450-0114",
            "Postal Collection Box":"700-7450-0115",
            "Tourist Information":"700-7460-0115",
            "Fueling Station":"700-7600-0000",
            "Petrol-Gasoline Station":"700-7600-0116",
            "EV Charging Station":"700-7600-0322",
            "EV Battery Swap Station":"700-7600-0325",
            "Hydrogen Fueling Station":"700-7600-0444",
            "Automobile Dealership-New Cars":"700-7800-0118",
            "Automobile Dealership-Used Cars":"700-7800-0119",
            "Motorcycle Dealership":"700-7800-0120",
            "Car Repair-Service":"700-7850-0000",
            "Car Wash-Detailing":"700-7850-0121",
            "Car Repair":"700-7850-0122",
            "Auto Parts":"700-7850-0123",
            "Emission Testing":"700-7850-0124",
            "Tire Repair":"700-7850-0125",
            "Truck Repair":"700-7850-0126",
            "Van Repair":"700-7850-0127",
            "Road Assistance":"700-7850-0128",
            "Automobile Club":"700-7850-0129",
            "Rental Car Agency":"700-7851-0117",
            "Carshare Location":"700-7851-0127",
            "Truck-Semi Dealer-Services":"700-7900-0000",
            "Truck Dealership":"700-7900-0130",
            "Truck Parking":"700-7900-0131",
            "Truck Stop-Plaza":"700-7900-0132",
            "Truck Wash":"700-7900-0323",
            "Hospital or Health Care Facility":"800-8000-0000",
            "Dentist-Dental Office":"800-8000-0154",
            "Family-General Practice Physicians":"800-8000-0155",
            "Psychiatric Institute":"800-8000-0156",
            "Nursing Home":"800-8000-0157",
            "Medical Services-Clinics":"800-8000-0158",
            "Hospital":"800-8000-0159",
            "Optical":"800-8000-0161",
            "Veterinarian":"800-8000-0162",
            "Hospital Emergency Room":"800-8000-0325",
            "Therapist":"800-8000-0340",
            "Chiropractor":"800-8000-0341",
            "Blood Bank":"800-8000-0367",
            "COVID-19 Testing Site":"800-8000-0400",
            "Vaccination Site":"800-8000-0401",
            "Government or Community Facility":"800-8100-0000",
            "City Hall":"800-8100-0163",
            "Embassy":"800-8100-0164",
            "Military Base":"800-8100-0165",
            "County Council":"800-8100-0168",
            "Civic-Community Center":"800-8100-0169",
            "Courthouse":"800-8100-0170",
            "Government Office":"800-8100-0171",
            "Border Crossing":"800-8100-0172",
            "Education Facility":"800-8200-0000",
            "Higher Education":"800-8200-0173",
            "Training and Development":"800-8200-0295",
            "Coaching Institute":"800-8200-0360",
            "Fine Arts":"800-8200-0361",
            "Language Studies":"800-8200-0362",
            "School":"800-8250-0000",
            "Primary School":"800-8250-0287",
            "Secondary School":"800-8250-0288",
            "Other Library":"800-8300-0000",
            "Library":"800-8300-0175",
            "Event Spaces":"800-8400-0000",
            "Banquet Hall":"800-8400-0139",
            "Convention-Exhibition Center":"800-8400-0176",
            "Parking":"800-8500-0000",
            "Parking Garage-Parking House":"800-8500-0177",
            "Parking Lot":"800-8500-0178",
            "Park and Ride or Fly":"800-8500-0179",
            "Motorcycle, Moped and Scooter Parking":"800-8500-0200",
            "Cellphone Parking Lot":"800-8500-0315",
            "Sports Facility-Venue":"800-8600-0000",
            "Sports Complex-Stadium":"800-8600-0180",
            "Ice Skating Rink":"800-8600-0181",
            "Swimming Pool":"800-8600-0182",
            "Tennis Court":"800-8600-0183",
            "Bowling Center":"800-8600-0184",
            "Indoor Ski":"800-8600-0185",
            "Hockey":"800-8600-0186",
            "Racquetball Court":"800-8600-0187",
            "Shooting Range":"800-8600-0188",
            "Soccer Club":"800-8600-0189",
            "Squash Court":"800-8600-0190",
            "Fitness-Health Club":"800-8600-0191",
            "Indoor Sports":"800-8600-0192",
            "Golf Course":"800-8600-0193",
            "Golf Practice Range":"800-8600-0194",
            "Race Track":"800-8600-0195",
            "Sporting Instruction and Camps":"800-8600-0196",
            "Sports Activities":"800-8600-0197",
            "Basketball":"800-8600-0199",
            "Badminton":"800-8600-0200",
            "Rugby":"800-8600-0314",
            "Diving Center":"800-8600-0316",
            "Bike Park":"800-8600-0376",
            "BMX Track":"800-8600-0377",
            "Running Track":"800-8600-0381",
            "Facilities":"800-8700-0000",
            "Cemetery":"800-8700-0166",
            "Crematorium":"800-8700-0167",
            "Public Restroom-Toilets":"800-8700-0198",
            "Clubhouse":"800-8700-0296",
            "Registration Office":"800-8700-0298",
            "Student Housing":"800-8700-0333",
            "City, Town or Village":"900-9100-0000",
            "Hamlet":"900-9100-0214",
            "Named Place":"900-9100-0215",
            "Neighborhood":"900-9100-0216",
            "Outdoor Area-Complex":"900-9200-0000",
            "Industrial Zone":"900-9200-0218",
            "Marina":"900-9200-0219",
            "RV Parks":"900-9200-0220",
            "Collective Community":"900-9200-0299",
            "Island":"900-9200-0301",
            "Meeting Point":"900-9200-0386",
            "Building":"900-9300-0000",
            "Residential Area-Building":"900-9300-0221",
            "Administrative Region-Streets":"900-9400-0000",
            "Administrative Region":"900-9400-0399",
            "Postal Area":"900-9400-0400",
            "Street or Square":"900-9400-0401",
            "Intersection":"900-9400-0402",
            }
        df = df[(df["Action"].str.upper() == "MODIFY") &
                df["New Category"].isin(category_map) &
                df["Previous Category"].isin(category_map)]
        result = pd.DataFrame({
            "PLACEID": df["PlaceID"],
            "CHANGETYPE": "UPDATE",
            "ATTRIBUTENAME": "CATEGORY",
            "PRIMARYCATEGORY": "TRUE",
            "CATEGORYSYSTEMTYPE": "navteq-lcms",
            "ID": df["New Category"].map(category_map),
            "PREVIOUSCATEGORYSYSTEMTYPE": "navteq-lcms",
            "PREVIOUSID": df["Previous Category"].map(category_map)
        })
        filename = f"Category_TEMPLATE_{timestamp}.csv"

    else:
        flash("Unknown action.")
        return redirect('/')

    output = BytesIO()
    result.to_csv(output, index=False, encoding='utf-8-sig')
    output.seek(0)
    return send_file(output, download_name=filename, as_attachment=True)

if __name__ == '__main__':
    app.run(debug=True)
